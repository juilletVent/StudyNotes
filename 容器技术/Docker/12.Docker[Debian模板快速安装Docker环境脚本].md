```shell
#!/bin/bash

# Docker安装和配置脚本 for Debian 12
# 作者: 自动生成
# 描述: 临时切换网关并安装配置Docker

set -e  # 遇到错误立即退出

echo "=========================================="
echo "开始执行Docker安装和配置脚本"
echo "=========================================="

apt update
apt install -y curl wget net-tools

# 1. 临时将系统网关切换到 192.168.6.7
echo "步骤1: 临时切换网关到 192.168.6.7"
echo "当前路由表:"
route -n

# 获取当前默认网关
CURRENT_GATEWAY=$(route -n | grep '^0.0.0.0' | awk '{print $2}' | head -1)
echo "当前默认网关: $CURRENT_GATEWAY"

# 添加临时路由
echo "添加临时路由到 192.168.6.7..."
route add default gw 192.168.6.7
# 删除原先的默认网关
route del default gw $CURRENT_GATEWAY

echo "路由表更新后:"
route -n

# 2. 下载Docker安装脚本
echo ""
echo "步骤2: 下载Docker安装脚本"
curl -fsSL https://get.docker.com -o get-docker.sh

if [ $? -eq 0 ]; then
    echo "Docker安装脚本下载成功"
else
    echo "错误: 下载Docker安装脚本失败"
    exit 1
fi

# 3. 执行Docker安装脚本
echo ""
echo "步骤3: 执行Docker安装脚本"
echo "这可能需要几分钟时间，请耐心等待..."
sh get-docker.sh
# 安装docker compose
apt-get install docker-compose-plugin -y

if [ $? -eq 0 ]; then
    echo "Docker安装成功"
else
    echo "错误: Docker安装失败"
    exit 1
fi

# 4. 创建Docker配置文件
echo ""
echo "步骤4: 创建Docker配置文件 /etc/docker/daemon.json"

# 检查目录是否存在，不存在则创建
if [ ! -d "/etc/docker" ]; then
    echo "创建 /etc/docker 目录..."
    mkdir -p /etc/docker
fi

# 创建配置文件
tee /etc/docker/daemon.json > /dev/null << 'EOF'
{
  "registry-mirrors": ["http://192.168.6.207:8181"],
  "insecure-registries": ["192.168.6.207:8181"]
}
EOF

if [ $? -eq 0 ]; then
    echo "Docker配置文件创建成功"
    echo "配置文件内容:"
    cat /etc/docker/daemon.json
else
    echo "错误: 创建Docker配置文件失败"
    exit 1
fi

# 5. 重启Docker服务
echo ""
echo "步骤5: 重启Docker服务"
systemctl restart docker

if [ $? -eq 0 ]; then
    echo "Docker服务重启成功"
else
    echo "错误: Docker服务重启失败"
    exit 1
fi

# 6. 验证Docker安装
echo ""
echo "步骤6: 验证Docker安装"
docker --version
docker info | grep -A 5 "Registry Mirrors"
docker info | grep -A 5 "Insecure Registries"

# 7. 恢复原始网关（可选）
echo ""
echo "步骤7: 恢复原始网关"
echo "注意: 临时路由在系统重启后会失效"
echo "如果要永久恢复原始网关，请手动执行:"
echo "route del default gw 192.168.6.7"
echo "route add default gw $CURRENT_GATEWAY"

echo ""
echo "=========================================="
echo "脚本执行完成!"
echo "=========================================="
echo ""
echo "重要提示:"
echo "1. 临时网关设置会在系统重启后失效"
echo "2. 要测试Docker是否正常工作，可以运行: docker run hello-world"
echo "3. 要将当前用户添加到docker组（避免使用，运行:"
echo "   usermod -aG docker \$USER"
echo "   然后重新登录或运行: newgrp docker"
echo "4. 查看Docker服务状态: systemctl status docker"
echo "5. 查看Docker日志: journalctl -u docker.service"

exit 0

```
