## 前置机配置

```shell
#!/bin/bash

# 前置机IP
sServer=1.1.1.1
# 中转机IP
dServer=2.2.2.2
# 中转端口范围
portRange=50000:59999

# PREROUTING
iptables -t nat -I PREROUTING -p tcp --dport $portRange -j DNAT --to-destination $dServer
iptables -t nat -I PREROUTING -p udp --dport $portRange -j DNAT --to-destination $dServer

# FORWARD
iptables -I FORWARD -p tcp --dport $portRange -j ACCEPT
iptables -I FORWARD -p udp --dport $portRange -j ACCEPT

# POSTROUTING
iptables -t nat -I POSTROUTING -p tcp --dport $portRange -j SNAT --to-source $sServer
iptables -t nat -I POSTROUTING -p udp --dport $portRange -j SNAT --to-source $sServer

# INPUT
iptables -I INPUT -p tcp --dport $portRange -j ACCEPT
iptables -I FORWARD -p udp --dport $portRange -j ACCEPT
```

## 中转机过白

> 开机自动运行一次，ipt-init.sh：

```shell
#!/bin/bash

# 前置机地址
sServer=1.1.1.1
# 中转端口范围
portRange=50000:59999

# Forward允许通过（双向的）
iptables -I FORWARD -s $sServer -j ACCEPT
iptables -I FORWARD -d $sServer -j ACCEPT
# 默认策略丢弃
iptables -P FORWARD DROP

# 屏蔽ICMP request
iptables -I INPUT -p icmp --icmp-type echo-request -j DROP

# INPUT 链处理DROP规则
iptables -I INPUT -p tcp --dport portRange ! -s $sServer -m state --state NEW -j DROP
iptables -I INPUT -p udp --dport portRange ! -s $sServer -m state --state NEW -j DROP
```

> cron 定时任务，没 5 秒运行一次，ipt-disable-forward.sh：

```shell
#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
iptables -P FORWARD DROP
```

配置定时任务，每五秒执行一次，注意修改脚本存放位置为实际位置：

```cron
* * * * * /root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 5;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 10;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 15;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 20;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 25;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 30;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 35;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 40;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 45;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 50;/root/iptable-start/ipt-disable-forward.sh
* * * * * sleep 55;/root/iptable-start/ipt-disable-forward.sh
```

## 查看常用指令

```shell
iptables -t nat -L PREROUTING -nv --line-num
iptables -t nat -L POSTROUTING -nv --line-num
iptables -L FORWARD -nv --line-num
iptables -L INPUT -nv --line-num
```
