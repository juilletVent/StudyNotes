## 端口扫描防御

```shell
# 限制并发不能超过3
iptables -I INPUT -p tcp --dport 22 -m connlimit --connlimit-above 3 -j DROP
# 为22端口数据包打上标记，集合标记为SSH，可自定义
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
# 检测SSH标记的数据包，如果在300秒内超过3个，就丢弃
iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP
```

## 端口敲门

```shell
iptables -P INPUT DROP
iptables -A INPUT -s 127.0.0.1/32 -j ACCEPT
iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# 使用长度为128的ping包敲门
iptables -A INPUT -p icmp --icmp-type 8 -m length --length 128 -m recent --set --name SSHOPEN --rsource -j ACCEPT
# 放行ping包
iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT
# 检测SSHOPEN标记的数据包，如果在15秒内有新的数据包，就放行
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --rcheck --seconds 15 --name SSHOPEN --rsource -j ACCEPT
```

```shell
#!/bin/bash

iptables -N port_scan_block


# 允许已建立的连接及相关的数据包通过
iptables -A port_scan_block -m conntrack --ctstate RELATED,ESTABLISHED -j RETURN

# 使用hashlimit模块限制每分钟TCP SYN连接数为360个
iptables -A port_scan_block -p tcp --syn -m hashlimit --hashlimit-above 360/minute --hashlimit-mode srcip --hashlimit-name synlimit -m recent --set -j RETURN

# 使用recent模块检查是否已经加入黑名单
iptables -A INPUT -m recent --name synlimit --rcheck --seconds 300 -j DROP

# 如果未加入黑名单，则将IP加入黑名单两小时
iptables -A INPUT -m recent --name synlimit --set -j ACCEPT

# 其他未匹配规则的数据包拒绝
iptables -A INPUT -j DROP

# ============================================
iptables -N port_protect
# 为新连接打上标记
iptables -A port_protect -p tcp -m multiport --dports 5001,10000,15000,20000,25000,30000,35000,40000,45000,49999,60000,61000,62000,63000,64000,65000 -m state --state NEW -m recent --set --name PORT_PROTECT
# 半个小时内
iptables -A port_protect -p tcp --dport 10:65535 -m state --state NEW -m recent --update --seconds 1800 --hitcount 1 --name PORT_PROTECT -j DROP

iptables -I INPUT -j port_protect
iptables -I FORWARD -j port_protect

# sysctl net.netfilter.nf_conntrack_max

```
